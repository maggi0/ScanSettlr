version: '3.8'

services:
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    networks:
      - node-network

  scan-settlr-app:
    build:
      context: scansettlr-main
      dockerfile: Dockerfile
    container_name: scan-settlr-app
    ports:
      - "8080:8080"
      - "5005:5005"
    environment:
      SPRING_DATA_MONGODB_URI: ${SPRING_DATA_MONGODB_URI}
      APP_SECRET_KEY: ${APP_SECRET_KEY}
      OLLAMA_BASE_URL: http://ollama:11434
      OCR_SERVER_URL: http://ocr-server:8000
    depends_on:
      - mongodb
      - ollama
      - ocr-server
    networks:
      - node-network

  ollama:
    image: ollama/ollama
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - node-network
    entrypoint: [ "/bin/sh", "-c" ]
    command: >
      "
      ollama serve &
      sleep 5 &&
      ollama pull mistral &&
      wait
      "

  ocr-server:
    build:
      context: scansettlr-ocr
      dockerfile: Dockerfile
    container_name: ocr-server
    ports:
      - "8000:8000"
    networks:
      - node-network

volumes:
  mongo-data:
  ollama-data:

networks:
  node-network:
    driver: bridge